const keyDirectory = {
  'keycode-192': {
    getValue: true,
    engKeyName: {
      standardKeyName: '`',
      shiftKeyName: '~',
    },
    rusKeyName: {
      standardKeyName: 'ё',
      shiftKeyName: 'Ё',
    },
  },
  'keycode-49': {
    getValue: true,
    engKeyName: {
      standardKeyName: '1',
      shiftKeyName: '!',
    },
    rusKeyName: {
      standardKeyName: '1',
      shiftKeyName: '!',
    },
  },
  'keycode-50': {
    getValue: true,
    engKeyName: {
      standardKeyName: '2',
      shiftKeyName: '@',
    },
    rusKeyName: {
      standardKeyName: '2',
      shiftKeyName: '"',
    },
  },
  'keycode-51': {
    getValue: true,
    engKeyName: {
      standardKeyName: '3',
      shiftKeyName: '#',
    },
    rusKeyName: {
      standardKeyName: '3',
      shiftKeyName: '№',
    },
  },
  'keycode-52': {
    getValue: true,
    engKeyName: {
      standardKeyName: '4',
      shiftKeyName: '$',
    },
    rusKeyName: {
      standardKeyName: '4',
      shiftKeyName: ';',
    },
  },
  'keycode-53': {
    getValue: true,
    engKeyName: {
      standardKeyName: '5',
      shiftKeyName: '%',
    },
    rusKeyName: {
      standardKeyName: '5',
      shiftKeyName: '%',
    },
  },
  'keycode-54': {
    getValue: true,
    engKeyName: {
      standardKeyName: '6',
      shiftKeyName: '^',
    },
    rusKeyName: {
      standardKeyName: '6',
      shiftKeyName: ':',
    },
  },
  'keycode-55': {
    getValue: true,
    engKeyName: {
      standardKeyName: '7',
      shiftKeyName: '&',
    },
    rusKeyName: {
      standardKeyName: '7',
      shiftKeyName: '?',
    },
  },
  'keycode-56': {
    getValue: true,
    engKeyName: {
      standardKeyName: '8',
      shiftKeyName: '*',
    },
    rusKeyName: {
      standardKeyName: '8',
      shiftKeyName: '*',
    },
  },
  'keycode-57': {
    getValue: true,
    engKeyName: {
      standardKeyName: '9',
      shiftKeyName: '(',
    },
    rusKeyName: {
      standardKeyName: '9',
      shiftKeyName: '(',
    },
  },
  'keycode-48': {
    getValue: true,
    engKeyName: {
      standardKeyName: '0',
      shiftKeyName: ')',
    },
    rusKeyName: {
      standardKeyName: '0',
      shiftKeyName: ')',
    },
  },
  'keycode-189': {
    getValue: true,
    engKeyName: {
      standardKeyName: '-',
      shiftKeyName: '_',
    },
    rusKeyName: {
      standardKeyName: '-',
      shiftKeyName: '_',
    },
  },
  'keycode-187': {
    getValue: true,
    engKeyName: {
      standardKeyName: '=',
      shiftKeyName: '+',
    },
    rusKeyName: {
      standardKeyName: '=',
      shiftKeyName: '+',
    },
  },
  'keycode-8': {
    getValue: false,
  },
  'keycode-9': {
    getValue: false,
  },
  'keycode-81': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'q',
      shiftKeyName: 'Q',
    },
    rusKeyName: {
      standardKeyName: 'й',
      shiftKeyName: 'Й',
    },
  },
  'keycode-87': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'w',
      shiftKeyName: 'W',
    },
    rusKeyName: {
      standardKeyName: 'ц',
      shiftKeyName: 'Ц',
    },
  },
  'keycode-69': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'e',
      shiftKeyName: 'E',
    },
    rusKeyName: {
      standardKeyName: 'у',
      shiftKeyName: 'У',
    },
  },
  'keycode-82': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'r',
      shiftKeyName: 'R',
    },
    rusKeyName: {
      standardKeyName: 'к',
      shiftKeyName: 'К',
    },
  },
  'keycode-84': {
    getValue: true,
    engKeyName: {
      standardKeyName: 't',
      shiftKeyName: 'T',
    },
    rusKeyName: {
      standardKeyName: 'е',
      shiftKeyName: 'Е',
    },
  },
  'keycode-89': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'y',
      shiftKeyName: 'Y',
    },
    rusKeyName: {
      standardKeyName: 'н',
      shiftKeyName: 'Н',
    },
  },
  'keycode-85': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'u',
      shiftKeyName: 'U',
    },
    rusKeyName: {
      standardKeyName: 'г',
      shiftKeyName: 'Г',
    },
  },
  'keycode-73': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'i',
      shiftKeyName: 'I',
    },
    rusKeyName: {
      standardKeyName: 'ш',
      shiftKeyName: 'Ш',
    },
  },
  'keycode-79': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'o',
      shiftKeyName: 'O',
    },
    rusKeyName: {
      standardKeyName: 'щ',
      shiftKeyName: 'Щ',
    },
  },
  'keycode-80': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'p',
      shiftKeyName: 'P',
    },
    rusKeyName: {
      standardKeyName: 'з',
      shiftKeyName: 'З',
    },
  },
  'keycode-219': {
    getValue: true,
    engKeyName: {
      standardKeyName: '[',
      shiftKeyName: '{',
    },
    rusKeyName: {
      standardKeyName: 'х',
      shiftKeyName: 'Х',
    },
  },
  'keycode-221': {
    getValue: true,
    engKeyName: {
      standardKeyName: ']',
      shiftKeyName: '}',
    },
    rusKeyName: {
      standardKeyName: 'ъ',
      shiftKeyName: 'Ъ',
    },
  },
  'keycode-46': {
    getValue: false,
  },
  'keycode-220': {
    getValue: true,
    engKeyName: {
      standardKeyName: '\\',
      shiftKeyName: '|',
    },
    rusKeyName: {
      standardKeyName: '\\',
      shiftKeyName: '/',
    },
  },
  'keycode-20': {
    getValue: false,
  },
  'keycode-65': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'a',
      shiftKeyName: 'A',
    },
    rusKeyName: {
      standardKeyName: 'ф',
      shiftKeyName: 'Ф',
    },
  },
  'keycode-83': {
    getValue: true,
    engKeyName: {
      standardKeyName: 's',
      shiftKeyName: 'S',
    },
    rusKeyName: {
      standardKeyName: 'ы',
      shiftKeyName: 'Ы',
    },
  },
  'keycode-68': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'd',
      shiftKeyName: 'D',
    },
    rusKeyName: {
      standardKeyName: 'в',
      shiftKeyName: 'В',
    },
  },
  'keycode-70': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'f',
      shiftKeyName: 'F',
    },
    rusKeyName: {
      standardKeyName: 'а',
      shiftKeyName: 'А',
    },
  },
  'keycode-71': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'g',
      shiftKeyName: 'G',
    },
    rusKeyName: {
      standardKeyName: 'п',
      shiftKeyName: 'П',
    },
  },
  'keycode-72': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'h',
      shiftKeyName: 'H',
    },
    rusKeyName: {
      standardKeyName: 'р',
      shiftKeyName: 'Р',
    },
  },
  'keycode-74': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'j',
      shiftKeyName: 'J',
    },
    rusKeyName: {
      standardKeyName: 'о',
      shiftKeyName: 'О',
    },
  },
  'keycode-75': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'k',
      shiftKeyName: 'K',
    },
    rusKeyName: {
      standardKeyName: 'л',
      shiftKeyName: 'Л',
    },
  },
  'keycode-76': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'l',
      shiftKeyName: 'L',
    },
    rusKeyName: {
      standardKeyName: 'д',
      shiftKeyName: 'Д',
    },
  },
  'keycode-186': {
    getValue: true,
    engKeyName: {
      standardKeyName: ';',
      shiftKeyName: ':',
    },
    rusKeyName: {
      standardKeyName: 'ж',
      shiftKeyName: 'Ж',
    },
  },
  'keycode-222': {
    getValue: true,
    engKeyName: {
      standardKeyName: '\'',
      shiftKeyName: '"',
    },
    rusKeyName: {
      standardKeyName: 'э',
      shiftKeyName: 'Э',
    },
  },
  'keycode-13': {
    getValue: false,
  },
  'keycode-left-16': {
    getValue: false,
  },
  'keycode-90': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'z',
      shiftKeyName: 'Z',
    },
    rusKeyName: {
      standardKeyName: 'я',
      shiftKeyName: 'Я',
    },
  },
  'keycode-88': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'x',
      shiftKeyName: 'X',
    },
    rusKeyName: {
      standardKeyName: 'ч',
      shiftKeyName: 'Ч',
    },
  },
  'keycode-67': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'c',
      shiftKeyName: 'C',
    },
    rusKeyName: {
      standardKeyName: 'с',
      shiftKeyName: 'С',
    },
  },
  'keycode-86': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'v',
      shiftKeyName: 'V',
    },
    rusKeyName: {
      standardKeyName: 'м',
      shiftKeyName: 'М',
    },
  },
  'keycode-66': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'b',
      shiftKeyName: 'B',
    },
    rusKeyName: {
      standardKeyName: 'и',
      shiftKeyName: 'И',
    },
  },
  'keycode-78': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'n',
      shiftKeyName: 'N',
    },
    rusKeyName: {
      standardKeyName: 'т',
      shiftKeyName: 'Т',
    },
  },
  'keycode-77': {
    getValue: true,
    engKeyName: {
      standardKeyName: 'm',
      shiftKeyName: 'M',
    },
    rusKeyName: {
      standardKeyName: 'ь',
      shiftKeyName: 'Ь',
    },
  },
  'keycode-188': {
    getValue: true,
    engKeyName: {
      standardKeyName: ',',
      shiftKeyName: '<',
    },
    rusKeyName: {
      standardKeyName: 'б',
      shiftKeyName: 'Б',
    },
  },
  'keycode-190': {
    getValue: true,
    engKeyName: {
      standardKeyName: '.',
      shiftKeyName: '>',
    },
    rusKeyName: {
      standardKeyName: 'ю',
      shiftKeyName: 'Ю',
    },
  },
  'keycode-191': {
    getValue: true,
    engKeyName: {
      standardKeyName: '/',
      shiftKeyName: '?',
    },
    rusKeyName: {
      standardKeyName: '.',
      shiftKeyName: ',',
    },
  },
  'keycode-38': {
    getValue: false,
    engKeyName: {
      standardKeyName: '↑',
      shiftKeyName: '↑',
    },
    rusKeyName: {
      standardKeyName: '↑',
      shiftKeyName: '↑',
    },
  },
  'keycode-right-16': {
    getValue: false,
  },
  'keycode-left-17': {
    getValue: false,
  },
  'keycode-91': {
    getValue: false,
  },
  'keycode-left-18': {
    getValue: false,
  },
  'keycode-32': {
    getValue: false,
  },
  'keycode-right-18': {
    getValue: false,
  },
  'keycode-right-17': {
    getValue: false,
  },
  'keycode-37': {
    getValue: false,
    engKeyName: {
      standardKeyName: '←',
      shiftKeyName: '←',
    },
    rusKeyName: {
      standardKeyName: '←',
      shiftKeyName: '←',
    },
  },
  'keycode-40': {
    getValue: false,
    engKeyName: {
      standardKeyName: '↓',
      shiftKeyName: '↓',
    },
    rusKeyName: {
      standardKeyName: '↓',
      shiftKeyName: '↓',
    },
  },
  'keycode-39': {
    getValue: false,
    engKeyName: {
      standardKeyName: '→',
      shiftKeyName: '→',
    },
    rusKeyName: {
      standardKeyName: '→',
      shiftKeyName: '→',
    },
  },
  language: {
    getValue: false,
  },
};

class Keyboard {
  constructor() {
    this.main = null;
    this.keysContainer = null;
    this.keys = [];
    this.language = null;
    this.property = {
      capsLock: {
        press: false,
        repeat: false,
      },
      shift: {
        press: false,
        repeat: false,
      },
      alt: {
        press: false,
        repeat: false,
      },
    };
  }

  init() {
    this.main = document.createElement('div');
    this.keysContainer = document.createElement('div');

    this.main.classList.add('keyboard');
    this.keysContainer.classList.add('keyboard__keys');
    this.keysContainer.appendChild(this.createKeys());

    this.keys = this.keysContainer.querySelectorAll('.keyboard__key');

    this.main.appendChild(this.keysContainer);
    document.body.prepend(this.main);
  }

  createKeys() {
    try {
      if (localStorage.getItem('language') === 'engKeyName' || localStorage.getItem('language') === 'rusKeyName') {
        this.language = localStorage.getItem('language');
      } else {
        this.language = 'engKeyName';
      }
    } catch (err) {
      this.language = 'engKeyName';
    }

    const fragment = document.createDocumentFragment();

    Object.keys(keyDirectory).forEach((key) => {
      const keyElement = document.createElement('button');

      keyElement.setAttribute('type', 'button');
      keyElement.setAttribute('data-keycode', key.replace(/[a-z -]/g, ''));
      keyElement.setAttribute('data-get-value', keyDirectory[key].getValue);
      keyElement.classList.add('keyboard__key');

      switch (key) {
        case 'keycode-8':
          this.createButtonStyle.call(keyElement, 'Backspace', 'key_large-wide');
          break;
        case 'keycode-9':
          this.createButtonStyle.call(keyElement, 'Tab', 'key_xs-wide');
          break;
        case 'keycode-20':
          this.createButtonStyle.call(keyElement, 'Caps Lock', 'key_small-wide', 'key_activated');
          break;
        case 'keycode-13':
          this.createButtonStyle.call(keyElement, 'Enter', 'key_xl-wide');
          break;
        case 'keycode-left-16':
          this.createButtonStyle.call(keyElement, 'Shift', 'key_large-wide');
          break;
        case 'keycode-right-16':
          this.createButtonStyle.call(keyElement, 'Shift', 'key_medium-wide');
          break;
        case 'keycode-32':
          this.createButtonStyle.call(keyElement, 'Space', 'key_xxl-wide');
          break;
        case 'keycode-left-17':
        case 'keycode-right-17':
          this.createButtonStyle.call(keyElement, 'Ctrl');
          break;
        case 'keycode-left-18':
        case 'keycode-right-18':
          this.createButtonStyle.call(keyElement, 'Alt');
          break;
        case 'keycode-91':
          this.createButtonStyle.call(keyElement, 'Win');
          break;
        case 'keycode-46':
          this.createButtonStyle.call(keyElement, 'Del');
          break;
        case 'language':
          keyElement.setAttribute('data-keycode', key);
          this.createButtonStyle.call(keyElement, this.language.substring(0, 3).toUpperCase(), 'key_language');
          break;
        default:
          keyElement.textContent = keyDirectory[key][this.language].standardKeyName;
          break;
      }
      fragment.appendChild(keyElement);
    });
    return fragment;
  }

  createButtonStyle(nameButton, ...className) {
    this.classList.add(...className);
    this.textContent = nameButton;
  }

  keyPress(event, keyUp = false) {
    const textArea = document.querySelector('.textarea');
    const textPosition = textArea.selectionStart;
    let keyPress = null;

    if (event.type === 'mousedown' || event.type === 'mouseup') {
      keyPress = event.target;
    } else {
      const keyRight = ['ShiftRight', 'AltRight', 'ControlRight'].includes(event.code);
      const keysArray = keyRight ? Array.from(this.keys).reverse() : Array.from(this.keys);

      keyPress = keysArray.find((key) => +key.dataset.keycode === event.keyCode);
    }

    function carriageMove(direction, number = 1) {
      switch (direction) {
        case 'left':
          textArea.selectionStart = (textPosition - number < 0) ? 0 : textPosition - number;
          break;
        case 'top':
          textArea.selectionStart = 0;
          break;
        case 'right':
          textArea.selectionStart = textPosition + number;
          break;
        case 'down':
          textArea.selectionStart = textArea.value.length;
          break;
        default:
          break;
      }
      textArea.selectionEnd = textArea.selectionStart;
    }

    function changeText([startPosition, deleteCount, newText], direction, number) {
      const textValue = textArea.value.split('');

      textValue.splice(startPosition, deleteCount, newText);

      textArea.value = textValue.join('');

      carriageMove(direction, number);
    }

    if (keyPress && !keyUp) {
      switch (keyPress.dataset.keycode) {
        case '8': // Backspace key
          changeText([textPosition - 1, 1], 'left');
          break;
        case '9': // Tab key
          changeText([textPosition, 0, '  '], 'right', 2);
          break;
        case '13': // Enter key
          changeText([textPosition, 0, '\n'], 'right');
          break;
        case '16': // Shift key
          this.property.shift.press = true;

          if (!this.property.shift.repeat) {
            this.property.shift.repeat = !this.property.shift.repeat;

            if (event.altKey) {
              this.changeLanguage();
            } else {
              this.switchValueKeys();
            }
          }
          break;
        case '18': // Alt key
          this.property.alt.press = true;

          if (!this.property.alt.repeat) {
            this.property.alt.repeat = !this.property.alt.repeat;

            if (event.shiftKey) {
              this.changeLanguage();
            }
          }
          break;
        case '20': // Caps Lock key
          if (!this.property.capsLock.repeat) {
            keyPress.classList.toggle('key_active');

            this.property.capsLock.press = !this.property.capsLock.press;
            this.property.capsLock.repeat = !this.property.capsLock.repeat;

            this.switchValueKeys();
          }
          break;
        case '32': // Space key
          changeText([textPosition, 0, ' '], 'right');
          break;
        case '37': // Left arrow-key
          carriageMove('left');
          break;
        case '38': // Up arrow-key
          carriageMove('top');
          break;
        case '39': // Right arrow-key
          carriageMove('right');
          break;
        case '40': // Down arrow-key
          carriageMove('down');
          break;
        case '46': // Delete key
          changeText([textPosition, 1], 'left', 0);
          break;
        case 'language':
          this.changeLanguage();
          break;
        default:
          if (keyPress.dataset.getValue === 'true') {
            changeText([textPosition, 0, keyPress.textContent], 'right');
          }
          break;
      }

      if (keyPress.getAttribute('type') === 'button') {
        keyPress.classList.add('key_hover', 'key_pressed');
      }
    }

    if (keyPress && keyUp) {
      keyPress.classList.remove('key_hover', 'key_pressed');

      switch (keyPress.dataset.keycode) {
        case '20':
          this.property.capsLock.repeat = !this.property.capsLock.repeat;
          break;
        case '16':
          this.property.shift.press = false;
          this.property.shift.repeat = !this.property.shift.repeat;
          this.switchValueKeys();
          break;
        case '18':
          this.property.alt.press = false;
          this.property.alt.repeat = !this.property.alt.repeat;
          break;
        default:
          break;
      }
    }
  }

  changeLanguage() {
    switch (this.language) {
      case 'engKeyName':
        this.language = 'rusKeyName';
        break;
      case 'rusKeyName':
        this.language = 'engKeyName';
        break;
      default:
        break;
    }

    localStorage.setItem('language', this.language);
    this.keys[this.keys.length - 1].textContent = this.language.substring(0, 3).toUpperCase();

    this.switchValueKeys();
  }

  switchValueKeys() {
    const code = [this.property.shift.press, this.property.alt.press, this.property.capsLock.press].join(', ');

    this.keys.forEach((item) => {
      const button = item;

      if (button.getAttribute('data-get-value') === 'true') {
        switch (code) {
          case 'true, false, false':
            button.textContent = keyDirectory[`keycode-${button.dataset.keycode}`][this.language].shiftKeyName;
            break;
          case 'true, false, true':
            button.textContent = keyDirectory[`keycode-${button.dataset.keycode}`][this.language].shiftKeyName.toLowerCase();
            break;
          case 'true, true, true':
          case 'false, true, true':
          case 'false, false, true':
            button.textContent = keyDirectory[`keycode-${button.dataset.keycode}`][this.language].standardKeyName.toUpperCase();
            break;
          default:
            button.textContent = keyDirectory[`keycode-${button.dataset.keycode}`][this.language].standardKeyName;
            break;
        }
      }
    });
  }
}

window.addEventListener('DOMContentLoaded', () => {
  const keyboard = new Keyboard();
  keyboard.init();

  const textArea = document.createElement('textarea');

  textArea.classList.add('textarea');
  textArea.setAttribute('autofocus', 'true');

  document.body.prepend(textArea);

  const information = document.createElement('div');
  const informationText = document.createElement('div');
  const informationTitle = document.createElement('div');

  information.classList.add('info');
  informationText.classList.add('info__text');
  informationTitle.classList.add('info__title');

  informationText.textContent = 'Made on Windows. Change language - Alt + Shift or click on button "ENG" ("RUS")';
  informationTitle.textContent = '!';

  information.append(informationText, informationTitle);

  document.body.append(information);

  setTimeout(() => {
    document.querySelector('.info').classList.toggle('info_active');
  }, 5000);

  textArea.addEventListener('blur', () => {
    textArea.focus();
  });

  textArea.addEventListener('mousedown', (event) => { // Not change textarea on left button click
    event.preventDefault();
  });

  textArea.addEventListener('contextmenu', (event) => { // Not change textarea on right button click
    event.preventDefault();
  });

  window.addEventListener('keydown', (event) => {
    event.preventDefault();
    keyboard.keyPress(event);
  });

  window.addEventListener('keyup', (event) => {
    keyboard.keyPress(event, true);
  });

  keyboard.keysContainer.addEventListener('mousedown', (event) => {
    if (event.target.dataset.keycode === '16') {
      keyboard.keyPress(event, event.target.classList.contains('key_pressed'));
    } else {
      keyboard.keyPress(event);
    }
  });

  keyboard.keysContainer.addEventListener('mouseup', (event) => {
    if (event.target.dataset.keycode !== '16') {
      keyboard.keyPress(event, true);
    }
  });

  document.querySelector('.info__title').addEventListener('click', () => {
    document.querySelector('.info').classList.toggle('info_active');
  });
});
